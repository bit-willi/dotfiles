#!/usr/bin/env bash

# Ask for sudo credentials *before* doing anything
sudo -v
if ! sudo -n true 2>/dev/null; then
    echo "ERROR: Failed to get sudo credentials. Aborting hibernation."
    exit 1
fi

swaylock_pid=$($HOME/.bin/lock --daemonize)

if ! [[ "$swaylock_pid" =~ ^[0-9]+$ ]]; then
    echo "ERROR: Failed to start swaylock from $HOME/.bin/lock"
    exit 1
fi

# Give swaylock a moment to start before hibernating
sleep 0.5

# Now that the screen is locked, hibernate
sudo systemctl hibernate

# --- Post-hibernate / Post-unlock Actions ---

# The script pauses here. After you resume and unlock,
# 'wait' will detect that the swaylock PID has finished.
wait "$swaylock_pid"

# Manually run the post-lock actions
pactl set-sink-mute @DEFAULT_SINK@ toggle
pkill -xu "$EUID" -USR2 dunst
