#!/usr/bin/env bash

# Create temporary files for the screenshot and the blurred version
screenshot_tmp=$(mktemp --suffix=.png)
screenshot_blur_tmp=$(mktemp --suffix=.png)

# Clean up temporary files on exit
trap 'rm -f "$screenshot_tmp" "$screenshot_blur_tmp"' EXIT

# 1. Take a screenshot using grim
grim "$screenshot_tmp"

# 2. Create the blurred effect using ImageMagick
magick "$screenshot_tmp" -scale 10% -scale 1000% "$screenshot_blur_tmp"

# 3. Define the options for swaylock
swaylock_options=(
    --image "$screenshot_blur_tmp"
    --show-failed-attempts
    --indicator-idle-visible
)

# --- Pre-lock Actions ---
pkill -xu "$EUID" -USR1 dunst
playerctl -a pause
pactl set-sink-mute @DEFAULT_SINK@ toggle

# --- Lock the screen ---
if [[ "$1" == "--daemonize" ]]; then
    # Daemonize: Run in background and echo the PID
    swaylock -n "${swaylock_options[@]}" &
    echo $!
else
    # Normal: Run in foreground and wait
    swaylock "${swaylock_options[@]}"

    # --- Post-lock Actions (only for normal mode) ---
    pactl set-sink-mute @DEFAULT_SINK@ toggle
    pkill -xu "$EUID" -USR2 dunst
fi
